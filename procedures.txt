create or alter procedure usp_listarEspecialidad
as
	Select * from tb_especialidad
go

--CURSOS
	CREATE OR ALTER PROCEDURE usp_listarCursos
	AS
	BEGIN
		SELECT 
			c.id_curso,
			c.nom_curso,
			c.creditos_curso,
			c.id_carrera,
			ca.nom_carrera
		FROM 
			tb_curso c
		INNER JOIN 
			tb_carrera ca ON c.id_carrera = ca.id_carrera
	END
	GO

CREATE OR ALTER PROCEDURE usp_registrarCurso
    @nom_curso       VARCHAR(50),
    @creditos_curso  SMALLINT,
    @id_carrera      INT
AS
BEGIN

    INSERT INTO tb_curso (nom_curso, creditos_curso, id_carrera)
    VALUES (@nom_curso, @creditos_curso, @id_carrera);
END
GO

CREATE OR ALTER PROCEDURE usp_buscarCurso
    @id_curso INT
AS
BEGIN
    SELECT
        c.id_curso,
        c.nom_curso,
        c.creditos_curso,
        c.id_carrera,
        ca.nom_carrera
    FROM tb_curso AS c
    INNER JOIN tb_carrera AS ca
        ON c.id_carrera = ca.id_carrera
    WHERE c.id_curso = @id_curso;
END
GO

CREATE OR ALTER PROCEDURE usp_actualizarCurso
    @id_curso        INT,
    @nom_curso       VARCHAR(50),
    @creditos_curso  SMALLINT,
    @id_carrera      INT
AS
BEGIN

    UPDATE tb_curso
    SET
        nom_curso      = @nom_curso,
        creditos_curso = @creditos_curso,
        id_carrera     = @id_carrera
    WHERE id_curso = @id_curso;
END
GO



--LOGIN

CREATE PROCEDURE sp_LoginUsuario 
    @correo VARCHAR(100),
    @contrasena VARCHAR(30),
    @login_exitoso BIT OUTPUT,
    @mensaje VARCHAR(100) OUTPUT,
    @id_usuario INT OUTPUT,
    @id_rol INT OUTPUT
AS
BEGIN
    SET NOCOUNT ON;
    
    SET @login_exitoso = 0;
    SET @mensaje = '';
    SET @id_usuario = 0;
    SET @id_rol = 0;
    
    IF EXISTS (
        SELECT 1 FROM tb_usuario 
        WHERE correo = @correo 
        AND contrasena = @contrasena
        AND estado = 1
    )
    BEGIN
        SELECT 
            @id_usuario = id_usuario,
            @id_rol = id_rol
        FROM tb_usuario
        WHERE correo = @correo
        AND contrasena = @contrasena
        AND estado = 1;
        
        IF @id_rol = 2
        BEGIN
            SET @mensaje = 'Acceso denegado para este tipo de usuario';
            SET @login_exitoso = 0;
            SET @id_usuario = 0;
            SET @id_rol = 0;
        END
        ELSE
        BEGIN
            SET @mensaje = 'Login exitoso';
            SET @login_exitoso = 1;
        END
    END
    ELSE
    BEGIN
        SET @mensaje = 'Usuario o contrase√±a incorrectos, o usuario inactivo';
    END
END
GO

CREATE PROCEDURE sp_ObtenerMenusPorRol
    @id_rol INT
AS
BEGIN
    SELECT 
        m.id_menu,
        m.titulo_menu,
        m.url_menu,
        m.orden,
		m.controlador
    FROM 
        tb_menu m
    INNER JOIN 
        tb_menu_rol mr ON m.id_menu = mr.id_menu
    WHERE 
        mr.id_rol = @id_rol
        AND m.es_activo = 1
    ORDER BY 
        m.orden
END
GO




--DOCENTES
create or alter procedure usp_listarDocentes
as
    select 
        U.id_usuario as id_docente, 
        U.nom_usuario + ' ' + U.ape_usuario as nom_docente, 
        E.nom_especialidad,
        U.estado
    from tb_usuario as U
    join tb_especialidad as E on U.cod_especialidad = E.cod_especialidad
    where U.id_rol = 2  -- Rol Docente
go


create or alter procedure usp_registrarDocentes(
    @nom_docente varchar(50),
    @ape_docente varchar(50),
    @correo varchar(100),
    @cod_especialidad int,
    @estado bit
)
as
begin
    insert into tb_usuario (
        nom_usuario,
        ape_usuario,
        correo,
        cod_especialidad,
        id_rol,
        estado
    ) values (
        @nom_docente,
        @ape_docente,
        @correo,
        @cod_especialidad,
        2,  -- ID 2 para rol docente
        @estado
    )
end
go

CREATE OR ALTER PROCEDURE usp_actualizarDocentes
    @id_docente INT,
    @nom_docente VARCHAR(50),
    @ape_docente VARCHAR(50),
    @correo VARCHAR(100),
    @cod_especialidad INT,
    @estado BIT
AS
BEGIN
    UPDATE tb_usuario
    SET 
        nom_usuario = @nom_docente,
        ape_usuario = @ape_docente,
        correo = @correo,
        cod_especialidad = @cod_especialidad,
        estado = @estado
    WHERE 
        id_usuario = @id_docente
        AND id_rol = 2; 
END
GO

CREATE OR ALTER PROCEDURE usp_buscarDocente
    @id_docente INT
AS
BEGIN
    SELECT 
        U.id_usuario AS id_docente,
        U.nom_usuario AS nom_docente,
        U.ape_usuario AS ape_docente,
        U.correo,
        U.cod_especialidad,
        E.nom_especialidad,
        U.estado
    FROM 
        tb_usuario U
    LEFT JOIN
        tb_especialidad E ON U.cod_especialidad = E.cod_especialidad
    WHERE 
        U.id_usuario = @id_docente
        AND U.id_rol = 2;  
END
GO

--AULAS

CREATE OR ALTER PROCEDURE usp_listarAulas
AS
BEGIN
    SET NOCOUNT ON;
    
    SELECT 
		id_aula,
        cod_aula,
        capacidad_aula,
        es_disponible
    FROM tb_aula;
END
GO

CREATE OR ALTER PROCEDURE usp_buscarAula
    @id_aula int
AS
BEGIN    
    SELECT 
		id_aula,
        cod_aula,
        capacidad_aula,
        es_disponible
    FROM tb_aula
    WHERE id_aula = @id_aula;
END
GO

CREATE OR ALTER PROCEDURE usp_registrarAulas
    @cod_aula       CHAR(4),
    @capacidad_aula SMALLINT,
    @es_disponible  BIT
AS
BEGIN    
    INSERT INTO tb_aula (cod_aula, capacidad_aula, es_disponible)
    VALUES (@cod_aula, @capacidad_aula, @es_disponible);
END
GO

CREATE OR ALTER PROCEDURE usp_actualizarAulas
	@id_aula		INT,
    @cod_aula       CHAR(4),
    @capacidad_aula SMALLINT,
    @es_disponible  BIT
AS
BEGIN
    UPDATE tb_aula
    SET 
		cod_aula       = @cod_aula,
        capacidad_aula = @capacidad_aula,
        es_disponible  = @es_disponible
    WHERE id_aula = @id_aula;
END
GO

--ALUMNOS

CREATE OR ALTER PROCEDURE usp_listarAlumnos
AS
BEGIN
    SELECT 
        id_usuario,
        nom_usuario + ' ' + ape_usuario as nom_usuario, 
        correo,
        contrasena,
        estado
    FROM tb_usuario
    WHERE id_rol = 3;  -- Alumno
END
GO

CREATE OR ALTER PROCEDURE usp_buscarAlumno
    @id_usuario INT
AS
BEGIN
    SELECT 
        id_usuario,
        nom_usuario,
        ape_usuario,
        correo,
        contrasena,
        estado
    FROM tb_usuario
    WHERE id_usuario = @id_usuario
      AND id_rol = 3;
END
GO

CREATE OR ALTER PROCEDURE usp_registrarAlumno
    @nom_usuario  VARCHAR(50),
    @ape_usuario  VARCHAR(50),
    @correo       VARCHAR(100),
    @contrasena   VARCHAR(30),
    @estado       BIT,
	@new_id_usuario INT OUTPUT

AS
BEGIN
    INSERT INTO tb_usuario
        (nom_usuario, ape_usuario, correo, contrasena, cod_especialidad, id_rol, estado)
    VALUES
        (@nom_usuario, @ape_usuario, @correo, @contrasena, NULL, 3, @estado);

	SET @new_id_usuario = SCOPE_IDENTITY();

END
GO

CREATE OR ALTER PROCEDURE usp_actualizarAlumno
    @id_usuario   INT,
    @nom_usuario  VARCHAR(50),
    @ape_usuario  VARCHAR(50),
    @correo       VARCHAR(100),
    @contrasena   VARCHAR(30),
    @estado       BIT
AS
BEGIN
    UPDATE tb_usuario
    SET 
        nom_usuario = @nom_usuario,
        ape_usuario = @ape_usuario,
        correo      = @correo,
        contrasena  = @contrasena,
        estado      = @estado
    WHERE id_usuario = @id_usuario
      AND id_rol = 3;
END
GO

CREATE OR ALTER PROCEDURE usp_BuscarPeriodoActual
AS
BEGIN
    SELECT 
        id_periodo,
        codigo_periodo,
        fcha_inicio,
        fcha_fin
    FROM 
        tb_periodo
    WHERE 
        CONVERT(DATE, GETDATE()) BETWEEN fcha_inicio AND fcha_fin;
END
GO

CREATE OR ALTER PROCEDURE usp_listarCarreras
AS
BEGIN
    SELECT id_carrera, nom_carrera
    FROM tb_carrera
    ORDER BY nom_carrera;
END
GO

CREATE OR ALTER PROCEDURE uspListarCarrerasPorUsuario
    @id_usuario INT
AS
BEGIN
    SELECT 
        c.id_carrera,
        c.nom_carrera
    FROM 
        tb_usuario_carrera uc
    INNER JOIN 
        tb_carrera c ON uc.id_carrera = c.id_carrera
    WHERE 
        uc.id_usuario = @id_usuario
    ORDER BY 
        c.nom_carrera
END
GO


CREATE OR ALTER PROCEDURE usp_eliminarCarrerasUsuario
    @id_usuario INT
AS
BEGIN
    DELETE FROM tb_usuario_carrera
    WHERE id_usuario = @id_usuario;
END
GO

-- 4) Asignar una carrera a un usuario
CREATE OR ALTER PROCEDURE usp_asignarCarreraUsuario
    @id_usuario  INT,
    @id_carrera  INT
AS
BEGIN
    INSERT INTO tb_usuario_carrera (id_usuario, id_carrera)
    VALUES (@id_usuario, @id_carrera);
END
GO

select * from tb_usuario_carrera

select * from tb_usuario